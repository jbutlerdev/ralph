#!/bin/bash
#
# Ralph Simple Bash Version
# 
# A lightweight CLI for the Ralph Wiggum technique - run the same AI prompt
# repeatedly until tasks are complete, with git-backed branching for 
# exploration and structured review at commit boundaries.
#
# Usage:
#   ./ralph-sh init <project-name>    - Initialize a new Ralph project
#   ./ralph-sh plan <task>            - Add a task to the plan
#   ./ralph-sh run                    - Run the next pending task
#   ./ralph-sh status                 - Show current status
#   ./ralph-sh branch <name>         - Create exploration branch
#   ./ralph-sh commit <message>      - Commit current changes
#   ./ralph-sh log                    - Show task execution log
#   ./ralph-sh help                   - Show this help message

set -e

# Configuration
RALPH_DIR=".ralph"
PLANS_DIR="plans"
LOG_FILE="$RALPH_DIR/execution.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ensure Ralph directories exist
ensure_dirs() {
    mkdir -p "$RALPH_DIR/sessions"
    mkdir -p "$RALPH_DIR/checkpoints"
    mkdir -p "$RALPH_DIR/prompts"
    mkdir -p "$PLANS_DIR"
}

# Initialize a new Ralph project
cmd_init() {
    local project_name="${1:-my-project}"
    
    ensure_dirs
    
    # Create initial plan file
    cat > "$PLANS_DIR/IMPLEMENTATION_PLAN.md" << EOF
# Implementation Plan: $project_name

## Overview
$project_name - Project initialized with Ralph

## Tasks

### Task 1: Initial Setup
**ID:** task-001
**Status:** To Do
**Priority:** high

**Description:**
Set up the initial project structure and dependencies.

**Acceptance Criteria:**
- [ ] Project structure created
- [ ] Dependencies installed

---
EOF

    log_success "Initialized Ralph project: $project_name"
    log_info "Edit $PLANS_DIR/IMPLEMENTATION_PLAN.md to add your tasks"
}

# Add a new task to the plan
cmd_plan() {
    local task_name="${1:-New Task}"
    local plan_file="$PLANS_DIR/IMPLEMENTATION_PLAN.md"
    
    if [ ! -f "$plan_file" ]; then
        log_error "No plan found. Run 'ralph-sh init' first."
        exit 1
    fi
    
    # Generate task ID
    local task_num=$(grep -c "^\### Task" "$plan_file" 2>/dev/null || echo "0")
    local new_num=$((task_num + 1))
    local task_id=$(printf "task-%03d" $new_num)
    
    # Append new task
    cat >> "$plan_file" << EOF

### Task $new_num: $task_name
**ID:** $task_id
**Status:** To Do
**Priority:** medium

**Description:**
$task_name

**Acceptance Criteria:**
- [ ] Criterion 1

---
EOF

    log_success "Added task: $task_name (ID: $task_id)"
}

# Show current status
cmd_status() {
    local plan_file="$PLANS_DIR/IMPLEMENTATION_PLAN.md"
    
    if [ ! -f "$plan_file" ]; then
        log_error "No plan found. Run 'ralph-sh init' first."
        exit 1
    fi
    
    echo ""
    echo "========================================"
    echo "         Ralph Execution Status"
    echo "========================================"
    echo ""
    
    # Count tasks by status
    local total=$(grep -c "^\### Task" "$plan_file" 2>/dev/null || echo "0")
    local todo=$(grep -c "**Status:** To Do" "$plan_file" 2>/dev/null || echo "0")
    local in_progress=$(grep -c "**Status:** In Progress" "$plan_file" 2>/dev/null || echo "0")
    local done=$(grep -c "**Status:** Implemented" "$plan_file" 2>/dev/null || echo "0")
    local verified=$(grep -c "**Status:** Verified" "$plan_file" 2>/dev/null || echo "0")
    
    echo "Progress: $(( (done + verified) * 100 / total ))% ($((done + verified))/$total tasks)"
    echo ""
    echo "  To Do:        $todo"
    echo "  In Progress:  $in_progress"
    echo "  Implemented:  $done"
    echo "  Verified:     $verified"
    echo ""
    
    # Show current branch
    echo "Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
    echo ""
}

# Run the next pending task
cmd_run() {
    local plan_file="$PLANS_DIR/IMPLEMENTATION_PLAN.md"
    
    if [ ! -f "$plan_file" ]; then
        log_error "No plan found. Run 'ralph-sh init' first."
        exit 1
    fi
    
    # Find next pending task
    local task_info=$(grep -A 10 "**Status:** To Do" "$plan_file" | head -15)
    
    if [ -z "$task_info" ]; then
        log_success "All tasks completed!"
        return
    fi
    
    local task_id=$(echo "$task_info" | grep "**ID:**" | head -1 | sed 's/.*\*\*ID:\*\* //' | tr -d ' ')
    local task_title=$(echo "$task_info" | grep "^\### Task" | sed 's/.*Task [0-9]*: //' | tr -d ' ')
    
    log_info "Starting task: $task_title ($task_id)"
    
    # Mark as in progress
    sed -i "s/\*\*Status:\*\* To Do/\*\*Status:\*\* In Progress/" "$plan_file"
    
    # Create prompt file for Claude
    cat > "$RALPH_DIR/prompts/$task_id.txt" << EOF
# Task: $task_title

$task_info

Complete this task using the Ralph Wiggum technique:
1. Make the necessary changes
2. Write tests first (TDD)
3. Commit your changes with a descriptive message

Task ID: $task_id
EOF

    log_info "Prompt saved to $RALPH_DIR/prompts/$task_id.txt"
    log_warn "Now run 'claude' to execute the task with the saved prompt"
    
    # Log execution
    echo "$(date -Iseconds) - Started task $task_id: $task_title" >> "$LOG_FILE"
}

# Mark current task as complete
cmd_done() {
    local plan_file="$PLANS_DIR/IMPLEMENTATION_PLAN.md"
    
    if [ ! -f "$plan_file" ]; then
        log_error "No plan found."
        exit 1
    fi
    
    # Find in-progress task and mark as implemented
    sed -i "s/\*\*Status:\*\* In Progress/\*\*Status:** Implemented/" "$plan_file"
    
    log_success "Task marked as completed"
}

# Create exploration branch
cmd_branch() {
    local branch_name="${1:-exploration}"
    
    git checkout -b "$branch_name" 2>/dev/null || {
        log_error "Failed to create branch. Ensure you're in a git repo."
        exit 1
    }
    
    log_success "Created and switched to branch: $branch_name"
}

# Commit current changes
cmd_commit() {
    local message="${1:-Update}"
    
    git add -A
    git commit -m "$message" 2>/dev/null || {
        log_warn "No changes to commit"
        return
    }
    
    log_success "Committed: $message"
}

# Show execution log
cmd_log() {
    if [ ! -f "$LOG_FILE" ]; then
        log_info "No execution log yet. Run some tasks first."
        return
    fi
    
    cat "$LOG_FILE"
}

# Show help
cmd_help() {
    cat << EOF
Ralph Simple Bash Version
=========================

A lightweight CLI for the Ralph Wiggum technique.

Usage:
  ./ralph-sh <command> [arguments]

Commands:
  init <name>     Initialize a new Ralph project
  plan <task>     Add a new task to the plan
  run             Run the next pending task
  done            Mark current task as complete
  status          Show current execution status
  branch <name>   Create exploration branch
  commit <msg>    Commit current changes
  log             Show execution log
  help            Show this help message

Examples:
  ./ralph-sh init my-app
  ./ralph-sh plan "Add user authentication"
  ./ralph-sh run
  ./ralph-sh status
  ./ralph-sh branch feature-x
  ./ralph-sh commit "Implemented auth"

Workflow:
  1. Initialize:   ralph-sh init <project>
  2. Plan:         ralph-sh plan <task> (or edit plan.md manually)
  3. Run:          ralph-sh run
  4. Work:         Claude Code executes the task
  5. Done:         ralph-sh done
  6. Review:       git diff && git commit
  7. Iterate:      ralph-sh run (next task) OR ralph-sh branch (explore)

EOF
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        init)
            cmd_init "$@"
            ;;
        plan)
            cmd_plan "$@"
            ;;
        run)
            cmd_run
            ;;
        done)
            cmd_done
            ;;
        status)
            cmd_status
            ;;
        branch)
            cmd_branch "$@"
            ;;
        commit)
            cmd_commit "$@"
            ;;
        log)
            cmd_log
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo "Run './ralph-sh help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
